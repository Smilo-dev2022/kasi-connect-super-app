<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Moderation Admin</title>
	<link rel="stylesheet" href="/static/style.css" />
</head>
<body>
	<header>
		<h1>Moderation Admin</h1>
	</header>
	<main>
		<section>
			<h2>Reports</h2>
			<div class="filters">
				<label>Status:
					<select id="status">
						<option value="">All</option>
						<option value="pending">Pending</option>
						<option value="queued">Queued</option>
						<option value="in_review">In Review</option>
						<option value="action_taken">Action Taken</option>
						<option value="dismissed">Dismissed</option>
					</select>
				</label>
				<button id="refresh">Refresh</button>
			</div>
			<div id="reports"></div>
		</section>
	</main>
	<script>
	async function api(path, opts) {
		const res = await fetch(path, opts);
		if (!res.ok) throw new Error('request_failed');
		return res.json();
	}

	async function loadReports() {
		const status = document.getElementById('status').value;
		const qs = status ? `?status=${encodeURIComponent(status)}` : '';
		const reports = await api(`/api/reports${qs}`);
		const container = document.getElementById('reports');
		if (!Array.isArray(reports) || reports.length === 0) {
			container.innerHTML = '<p>No reports yet.</p>';
			return;
		}
		container.innerHTML = '';
		reports.forEach(r => {
			const el = document.createElement('div');
			el.className = 'report';
			el.innerHTML = `
				<div class="row">
					<div><strong>ID</strong>: ${r.id}</div>
					<div><strong>Status</strong>: <span id="status-${r.id}">${r.status}</span></div>
					<div><strong>Reason</strong>: ${r.reason}</div>
				</div>
				<div class="actions">
					<button data-action="in_review" data-id="${r.id}">Mark In Review</button>
					<button data-action="action_taken" data-id="${r.id}">Action Taken</button>
					<button data-action="dismissed" data-id="${r.id}">Dismiss</button>
				</div>
			`;
			container.appendChild(el);
		});
	}

	async function updateStatus(id, status) {
		const span = document.getElementById(`status-${id}`);
		if (span) span.textContent = status; // optimistic
		try {
			await api(`/api/reports/${id}/status`, { method: 'PATCH', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ status }) });
		} catch (e) {
			await loadReports();
		}
	}

	document.addEventListener('click', (e) => {
		const t = e.target;
		if (t && t.matches('button[data-action]')) {
			const id = t.getAttribute('data-id');
			const action = t.getAttribute('data-action');
			updateStatus(id, action);
		}
	});

	document.getElementById('refresh').addEventListener('click', () => loadReports());
	document.getElementById('status').addEventListener('change', () => loadReports());
	loadReports();
	</script>
</body>
</html>